<?xml version="1.0" encoding="UTF-8"?>
<!-- Mapper의 이름은 Mapper 인터페이스와 맞춰준다. -->
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http:/mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- Mapper의 위치를 정확히 맞춰야 한다. -->
<mapper namespace="kr.co.ohgoodfood.dao.TestMapper">
    <!--
    Test용 Mapper 객체
        - 화면을 뿌리는데는 사용하지 않지만, test시 필요한 mapper를 따로 분리
        - 화면을 뿌리는데 사용하는 mapper랑..구분이 쉽도록 하기 위해 분리
    -->

    <!-- insertBookmark mapper -->
    <insert id="insertBookmark" parameterType="kr.co.ohgoodfood.dto.Bookmark">
        <!--selectKey로 auto increment 값을 가져온다.-->
        <selectKey resultType="int" keyProperty="bookmark_no" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
        INSERT INTO Bookmark(user_id, store_id)
        VALUES (#{user_id}, #{store_id});
    </insert>

    <!-- selectBookmark mapper -->
    <select id="selectOneBookmark" resultType="kr.co.ohgoodfood.dto.Bookmark">
        SELECT * FROM Bookmark b
        WHERE b.bookmark_no = #{bookmark_no};
    </select>

    <!-- [test 용] alarm selectOneAlarm -->
    <select id="selectOneAlarm" resultType="kr.co.ohgoodfood.dto.Alarm">
        SELECT * FROM Alarm
        WHERE alarm_no = #{alarm_no};
    </select>

    <insert id="insertOrder" parameterType="kr.co.ohgoodfood.dto.Orders">
        <!-- selectKey로 auto increment 값을 가져온다. -->
        <selectKey resultType="int" keyProperty="order_no" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
        INSERT INTO Orders(user_id, store_id, quantity, ordered_at, picked_at, order_status)
        VALUES (#{user_id}, #{store_id}, #{quantity}, #{ordered_at}, #{picked_at}, #{order_status});
    </insert>

    <!-- [test 용] Order selectOneOrder -->
    <select id="selectOneOrder" resultType="kr.co.ohgoodfood.dto.Orders">
        SELECT * FROM Orders o
        WHERE o.order_no = #{order_no}
        AND o.user_id = #{user_id};
    </select>

    <!-- [test 용] Order deleteOrder -->
    <delete id="deleteOrder" parameterType="kr.co.ohgoodfood.dto.Orders">
        DELETE FROM Orders
        WHERE order_no = #{order_no}
    </delete>

    <!-- [test 용] Bookmark deleteBookmark -->
    <delete id="deleteBookmark" parameterType="kr.co.ohgoodfood.dto.Bookmark">
        DELETE FROM Bookmark
        WHERE bookmark_no = #{bookmark_no}
    </delete>

    <!-- [test 용] MainStore selectOneStore -->
    <select id="selectOneStore" parameterType="map" resultType="kr.co.ohgoodfood.dto.MainStore">
        SELECT
            s.store_id AS store_id, s.store_name AS store_name, s.store_menu AS store_menu, s.store_address AS store_address, s.store_status AS store_status, s.category_bakery AS category_bakery, s.category_fruit AS category_fruit, s.category_salad AS category_salad, s.category_others AS category_others, s.closed_at AS closed_at,
            p.product_no AS product_no, p.pickup_start AS pickup_start, p.pickup_end AS pickup_end, p.origin_price AS origin_price, p.sale_price AS sale_price, p.product_explain AS product_explain, p.reservation_end AS reservation_end, p.amount AS amount,
            MIN(i.store_img) AS store_img,
            b.bookmark_no AS bookmark_no,
            CASE WHEN b.bookmark_no IS NOT NULL THEN true ELSE false END AS bookmark
        FROM Store s
            JOIN Product p ON s.store_id = p.store_id
            JOIN Image i ON i.store_id = s.store_id
            LEFT JOIN Bookmark b ON b.store_id = s.store_id AND b.user_id = #{user_id}
        <where>
            s.store_id = #{store_id}
        </where>
        GROUP BY s.store_id, s.store_name;
    </select>
</mapper>