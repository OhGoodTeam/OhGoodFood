<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.ohgoodfood.dao.mypage.MyPageMapper">

  <!-- MyPage 전체 매핑 -->
  <resultMap id="MyPageMap" type="kr.co.ohgoodfood.dto.MyPage">
    <!-- 내 정보 -->
    <result column="user_id"       property="user_id"/>
    <result column="user_nickname" property="user_nickname"/>

    <!-- 리뷰 리스트 매핑 -->
    <collection property="reviews" ofType="kr.co.ohgoodfood.dto.Review">
      <id     column="review_no"      property="review_no"/>
      <result column="review_content" property="review_content"/>
      <result column="writed_at"      property="writed_at"/>
      <result column="review_img"     property="review_img"/>

      <!-- 상품 정보 -->
      <result column="origin_price"   property="origin_price"/>
      <result column="sale_price"     property="sale_price"/>

      <!-- 가게 정보 -->
      <result column="store_id"       property="store_id"/>
      <result column="store_name"     property="store_name"/>
      <result column="store_menu"     property="store_menu"/>

      <!-- 대표 이미지 -->
      <result column="store_img"      property="store_img"/>
    </collection>
  </resultMap>

  <!-- MyPage 조회 SQL -->
  <select id="selectMyPage"
          parameterType="string"
          resultMap="MyPageMap">
    SELECT
      a.user_id,
      a.user_nickname,

      r.review_no,
      r.review_content,
      r.writed_at,
      r.review_img,

      p.origin_price,
      p.sale_price,

      s.store_id,
      s.store_name,
      s.store_menu,

      (
        SELECT i.store_img
          FROM Image i
         WHERE i.store_id = s.store_id
         ORDER BY i.img_no
         LIMIT 1
      ) AS store_img
    FROM Account a
    LEFT JOIN Review  r ON a.user_id = r.user_id
    LEFT JOIN Store   s ON r.store_id = s.store_id
    LEFT JOIN Product p ON p.store_id = s.store_id
    WHERE a.user_id = #{user_id}
    ORDER BY r.writed_at DESC
  </select>

</mapper>
