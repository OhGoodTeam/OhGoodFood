<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reviewWrite</title>
    <link rel="stylesheet" href="../../../css/userReviewWrite.css">
</head>

<body>
    <div id="wrapper">
        <header>
            <div class="headerContainer">
                <img src="../../../img/user_backdo.png" alt="뒤로가기" class="icon">
                <div class="iconContainer">
                    <img src="../../../img/user_alarm_active.png" alt="알람" class="icon">
                    <img src="../../../img/user_logout.png" alt="로그아웃" class="icon">
                </div>
            </div>
        </header>
        <main class="content">
            <h2 class="review">리뷰 작성</h2>
            <div class="reviewContainer">
                <!-- 상품 정보 카드 -->
                <div class="productCard">
                    <img class="storeImg" src="../../../img/user_pain.png" alt="가게이미지" />
                    <div class="details">
                        <p class="name">러프도우</p>
                        <p><span class="storeName" style="font-weight:bold;">구매처 :</span> <span>오목곰 베이커리</span></p>
                        <p><span class="productCount" style="font-weight:bold;">수량 :</span> <span>2개</span></p>
                        <p><span class="productPrice" style="font-weight:bold;">결제 금액 :</span> <span>6,900원</span></p>
                        <!-- <p class="name">${product.name}</p>
                    <p><span style="font-weight:bold;">구매처:</span> ${order.storeName}</p>
                    <p><span style="font-weight:bold;">수량:</span> ${order.quantity}개</p>
                    <p><span style="font-weight:bold;">결제 금액:</span> ${order.totalPrice}원</p> -->
                    </div>
                </div>
                <hr class="line" />
                <!-- 리뷰 입력 폼 -->
                <form action="${pageContext.request.contextPath}/review/submit" method="post"
                    enctype="multipart/form-data" class="reviewForm">
                    <!-- 리뷰 텍스트 -->
                    <span class="reviewInfo">
                        <strong class="reviewInfo__title">리뷰</strong>
                        <span class="reviewInfo__desc">100자 이내로 작성해주세요.</span>
                    </span>
                    <textarea id="reviewText" class="reviewText" placeholder="리뷰는 100자 이내로 작성해주세요." maxlength="100"
                        rows="6"></textarea>
                    <div class="charCount"><span id="currentCount"></span>/100</div>


                    <!-- 사진 업로드 -->
                    <div class="reviewPhoto">
                        <span class="photoLabel">
                            <span class="photoLabel__title">사진</span>
                            <span class="photoLabel__desc">사진은 필수로 첨부해주세요.</span>
                        </span>
                        <div class="photoInput">
                            <input type="file" id="photoFile" name="image" accept="image/*" hidden />
                            <button type="button" id="btnAddPhoto" class="btnAddPhoto">
                                <img src="../../../img/user_plusbtn.png" alt="사진 추가" />
                            </button>
                            <div id="photoPreview" class="photoPreview"></div>
                        </div>
                    </div>
            </div>

            <!-- 등록 버튼 -->
            <button type="submit" id="btnSubmit" class="btnSubmit" disabled>리뷰 등록하기</button>
            </form>
        </main>

    </div>
    <!-- Modal bottom sheet -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-sheet">
            <button id="btnCamera">카메라</button>
            <button id="btnGallery">갤러리에서 가져오기</button>
            <button id="btnCancel">취소</button>
        </div>
    </div>

    <script>
        $(function () {
            // character count
            $('#reviewText').on('input', function () {
                $('#currentCount').text(this.value.length);
            });

            const modal = $('#modalOverlay');
            const fileInput = $('#photoFile');
            const previewBox = $('#photoPreview');

            // show modal
            $('#btnAddPhoto').on('click', function () {
                modal.fadeIn(200).css('display', 'flex');
            });
            // hide modal
            $('#btnCancel').on('click', () => modal.fadeOut(200));
            modal.on('click', e => { if (e.target === modal[0]) modal.hide(); });

            // camera option
            $('#btnCamera').on('click', function () {
                fileInput.attr('capture', 'environment').click();
                modal.hide();
            });
            // gallery option
            $('#btnGallery').on('click', function () {
                fileInput.removeAttr('capture').click();
                modal.hide();
            });

            fileInput.on('change', function () {
                const file = this.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    previewBox.empty();
                    const wrapper = $('<div>').addClass('photoPreview-wrapper');
                    const img = $('<img>').attr('src', e.target.result);
                    const btn = $('<button>').addClass('remove-btn').text('×');

                    btn.on('click', () => {
                        previewBox.empty();
                        fileInput.val('');
                        $('#btnSubmit').prop('disabled', true);
                        $('#btnAddPhoto').show();     // ① 이미지 추가 버튼 다시 보이기
                    });

                    wrapper.append(img).append(btn);
                    previewBox.append(wrapper);

                    $('#btnSubmit').prop('disabled', false);
                    $('#btnAddPhoto').hide();      // ② 이미지 추가 버튼 숨기기
                };
                reader.readAsDataURL(file);
            });

        });
    </script>
</body>

</html>